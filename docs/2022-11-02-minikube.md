---
title: 'minikube'
layout: default
tags:
  - linux
  - k8s
category: 运维
---
k8s单机版。

<!--more-->

# 一、安装
https://minikube.sigs.k8s.io/docs/start/
https://minikube.kubernetes.ac.cn/docs/handbook/accessing/

## 1、下载minikube可执行文件
```
curl -Lo minikube https://kubernetes.oss-cn-hangzhou.aliyuncs.com/minikube/releases/v1.23.1/minikube-linux-amd64 
chmod +x minikube 
mv minikube /usr/local/bin/
```
## 2、启动minikube

### a.直接命令行启动 - 默认使用docker容器

```
minikube start

minikube start --force --driver=docker 

#查看服务状态
minikube profile list
minikube status
```

【注意】 docker做驱动无法直接对外机器访问，原因是minikube程序位于容器驱动中，而docker网络为独立网络，mac的hyperkit驱动可以
```
minikube start --listen-address=0.0.0.0 --driver='hyperkit' --vm=true --extra-config=apiserver.service-node-port-range=1-65535 --image-mirror-country='cn' --image-repository='registry.cn-hangzhou.aliyuncs.com/google_containers'
```

#### kyperkit安装
```
curl -LO https://storage.googleapis.com/minikube/releases/latest/docker-machine-driver-hyperkit && chmod +x docker-machine-driver-hyperkit && sudo mv docker-machine-driver-hyperkit /usr/local/bin/ && sudo chown root:wheel /usr/local/bin/docker-machine-driver-hyperkit && sudo chmod u+s /usr/local/bin/docker-machine-driver-hyperkit

# 查看安装状态
ll /usr/local/bin/ | grep docker-machine-driver-hyperkit

# 安装
brew install /usr/local/bin/docker-machine-driver-hyperkit

```

### b.启动参数
```
指定nodePort可用端口，默认时为30000+
--extra-config=apiserver.service-node-port-range=1-65535 

镜像空间
--image-mirror-country='cn' 
--image-repository='registry.cn-hangzhou.aliyuncs.com/google_containers'
```


### c.使用driver=none
```
#必须存在默认路由
ip route add default via 【192.168.0.1/当前网络】

minikube start --force --driver=none --extra-config=apiserver.service-node-port-range=1-65535 --image-mirror-country='cn' --image-repository='registry.cn-hangzhou.aliyuncs.com/google_containers' --kubernetes-version=v1.22.1
```

### d.镜像依赖
可直接docker save/load 的方式导入镜像以启动minikube
```
registry.cn-hangzhou.aliyuncs.com/google_containers/kicbase                   v0.0.27        9fa1cc16ad6d   3 years ago     1.08GB
registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver            v1.22.1        f30469a2491a   3 years ago     128MB
registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager   v1.22.1        6e002eb89a88   3 years ago     122MB
registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy                v1.22.1        36c4ebbc9d97   3 years ago     104MB
registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler            v1.22.1        aca5ededae9c   3 years ago     52.6MB
registry.cn-hangzhou.aliyuncs.com/google_containers/etcd                      3.5.0-0        004811815584   3 years ago     295MB
registry.cn-hangzhou.aliyuncs.com/google_containers/coredns                   v1.8.4         8d147537fb7d   3 years ago     47.5MB
registry.cn-hangzhou.aliyuncs.com/google_containers/storage-provisioner       v5             6e38f40d628d   3 years ago     31.5MB
registry.cn-hangzhou.aliyuncs.com/google_containers/pause                     3.5            ed210e3e4a5b   3 years ago     683kB
```

### e.配置离线文件
linux 将离线文件放于 ```root/.minikuke/cache``` 中


## 3、kubectl管理工具

### 直接安装
```
minikube kubectl -- get po -A

#设置别名
alias kubectl="minikube kubectl --"
```

### 下载安装
```
curl -Lo kubectl http://kubernetes.oss-cn-hangzhou.aliyuncs.com/kubernetes-release/release/v1.20.0/bin/linux/amd64/kubectl
chmod +x kubectl 
mv kubectl /usr/local/bin/
```

## 4、dashboard

### 镜像依赖
```
#使用minikube addons list可查看核心服务是否enable
minikube addons enable 【服务名】

# 基础依赖
registry.cn-hangzhou.aliyuncs.com/google_containers/dashboard                 v2.3.1         e1482a24335a   3 years ago     220MB
registry.cn-hangzhou.aliyuncs.com/google_containers/metrics-scraper           v1.0.7         7801cfc6d5c0   3 years ago     34.4MB

# CPU/内存查看依赖
registry.cn-hangzhou.aliyuncs.com/google_containers/metrics-server            v0.4.2         17c225a562d9   3 years ago     60.5MB
```

### 启动dashboard
```
minikube dashboard --url

#查看所有pod运行情况
minikube get pod -A 
```

### 重配dashboard网络
```
#查看所有网络配置 - 其中dashboard网络为ClusterIP，不支持外部访问
minikube get svc -A

#编辑service，将Service的spec.type从ClusterIP设置为nodePort即可对外访问
kubectl edit svc [service名称] -n [kubernetes-dashboard/namespace名称]

#也可直接 patch，无需 vi
kubectl patch svc kubernetes-dashboard -n kubernetes-dashboard \
  -p '{"spec": {"type": "NodePort", "ports": [{"port": 80, "targetPort": 9090, "nodePort": 30090}]}}'

#【重点】：spec.type改成NodePort，增加spec.ports.nodePort:8001 【对外访问的端口】

```

# 二、容器使用
### yaml部署
minikube中所有容器（pod、service、job等都可用yaml来配置，并且启动都必定存在yaml，
可用```kubectl get pod [pod命名] -n [namespace] -o yaml```查看，
使用```kubectl edit [pod/svc/...] [容器名] -n [namespace]```即可编辑该容器yaml并立即刷新，
其中```kubectl describe pod [name] -n [namespace]```可查看容器元数据状态，
使用```kubectl logs [name]```可查看运行时日志
```
# yaml格式的pod定义文件完整内容：
apiVersion: v1       #必选，版本号，例如v1
kind: Pod       #必选，Pod
metadata:       #必选，元数据
  name: string       #必选，Pod名称
  namespace: string    #必选，Pod所属的命名空间
  labels:      #自定义标签
    - name: string     #自定义标签名字
  annotations:       #自定义注释列表
    - name: string
spec:         #必选，Pod中容器的详细定义
  containers:      #必选，Pod中容器列表
  - name: string     #必选，容器名称
    image: string    #必选，容器的镜像名称
    imagePullPolicy: [Always | Never | IfNotPresent] #获取镜像的策略 Alawys表示下载镜像 IfnotPresent表示优先使用本地镜像，否则下载镜像，Nerver表示仅使用本地镜像
    command: [string]    #容器的启动命令列表，如不指定，使用打包时使用的启动命令
    args: [string]     #容器的启动命令参数列表
    workingDir: string     #容器的工作目录
    volumeMounts:    #挂载到容器内部的存储卷配置
    - name: string     #引用pod定义的共享存储卷的名称，需用volumes[]部分定义的的卷名
      mountPath: string    #存储卷在容器内mount的绝对路径，应少于512字符
      readOnly: boolean    #是否为只读模式
    ports:       #需要暴露的端口库号列表
    - name: string     #端口号名称
      containerPort: int   #容器需要监听的端口号
      hostPort: int    #容器所在主机需要监听的端口号，默认与Container相同
      protocol: string     #端口协议，支持TCP和UDP，默认TCP
    env:       #容器运行前需设置的环境变量列表
    - name: string     #环境变量名称
      value: string    #环境变量的值
    resources:       #资源限制和请求的设置
      limits:      #资源限制的设置
        cpu: string    #Cpu的限制，单位为core数，将用于docker run --cpu-shares参数
        memory: string     #内存限制，单位可以为Mib/Gib，将用于docker run --memory参数
      requests:      #资源请求的设置
        cpu: string    #Cpu请求，容器启动的初始可用数量
        memory: string     #内存清楚，容器启动的初始可用数量
    livenessProbe:     #对Pod内个容器健康检查的设置，当探测无响应几次后将自动重启该容器，检查方法有exec、httpGet和tcpSocket，对一个容器只需设置其中一种方法即可
      exec:      #对Pod容器内检查方式设置为exec方式
        command: [string]  #exec方式需要制定的命令或脚本
      httpGet:       #对Pod内个容器健康检查方法设置为HttpGet，需要制定Path、port
        path: string
        port: number
        host: string
        scheme: string
        HttpHeaders:
        - name: string
          value: string
      tcpSocket:     #对Pod内个容器健康检查方式设置为tcpSocket方式
         port: number
       initialDelaySeconds: 0  #容器启动完成后首次探测的时间，单位为秒
       timeoutSeconds: 0   #对容器健康检查探测等待响应的超时时间，单位秒，默认1秒
       periodSeconds: 0    #对容器监控检查的定期探测时间设置，单位秒，默认10秒一次
       successThreshold: 0
       failureThreshold: 0
       securityContext:
         privileged:false
    restartPolicy: [Always | Never | OnFailure]#Pod的重启策略，Always表示一旦不管以何种方式终止运行，kubelet都将重启，OnFailure表示只有Pod以非0退出码退出才重启，Nerver表示不再重启该Pod
    nodeSelector: obeject  #设置NodeSelector表示将该Pod调度到包含这个label的node上，以key：value的格式指定
    imagePullSecrets:    #Pull镜像时使用的secret名称，以key：secretkey格式指定
    - name: string
    hostNetwork:false      #是否使用主机网络模式，默认为false，如果设置为true，表示使用宿主机网络
    volumes:       #在该pod上定义共享存储卷列表
    - name: string     #共享存储卷名称 （volumes类型有很多种）
      emptyDir: {}     #类型为emtyDir的存储卷，与Pod同生命周期的一个临时目录。为空值
      hostPath: string     #类型为hostPath的存储卷，表示挂载Pod所在宿主机的目录
        path: string     #Pod所在宿主机的目录，将被用于同期中mount的目录
      secret:      #类型为secret的存储卷，挂载集群与定义的secre对象到容器内部
        scretname: string  
        items:     
        - key: string
          path: string
      configMap:     #类型为configMap的存储卷，挂载预定义的configMap对象到容器内部
        name: string
        items:
        - key: string
```
#### 例如：dashboard官方yaml
https://raw.githubusercontent.com/kubernetes/dashboard/v1.10.1/src/deploy/recommended/kubernetes-dashboard.yaml

### 命令部署
1、启动service后使用命令查看对外映射的url:
```
minikube service [service-name] --url

kubectl get service <service-name> --output='jsonpath="{.spec.ports[0].nodePort}"'
```
查看[service-name]```kubectl get server``` 

2、查看service映射外部的端口
```
minikube kubectl -- get service
```
3、使用命令转发service
```
kubectl port-forward [service] 9080:80
```

4、进入容器
```
kubectl exec -it [pod-name] -- sh
```

5、测试转发
```
kubectl port-forward --address 0.0.0.0  svc/[service-name] 80:8080
```

6、日志
```
kubectl logs pod <pod name>
```

# 三、常用命令

1、启动集群```minikube start```

2、查看集群状态```minikube status```

3、访问在 minikube 集群中运行的 kubernetes dashboard```minikube dashboard```

4、停止集群中的容器```minikube pause```

5、恢复集群中的容器```minikube unpuase```

6、查看虚拟机ip```minikube ip```

7、登陆到虚拟机```minikube ssh```

8、删除minikube集群```minikube delete --purge --all```

9、查看资源细节```kubectl describe <资源> <资源名称> #kubectl describe pod/service mysql-server```

10、重启容器：
```
#强制重启
kubectl rollout restart pod [pod名称] -n [namespace名称]

#编辑资源重启
kubectl edit
```

# 四、插件安装

1、查询插件列表```minikube addons list```

2、启动置顶插件```minikube addons enable <name>``` or ``` minikube start --addons <name1> --addons <name2>```

3、停用插件```minikube addons disable <name>```


# 五、配置aliyun镜像仓库

在阿里云控制台创建仓库：https://cr.console.aliyun.com

1、登录阿里云
```docker login --username=xxx@hotmail.com registry.cn-hangzhou.aliyuncs.com```

2、在master上生成密钥
```
kubectl create secret docker-registry alidockerregistryssecret --docker-server=registry.cn-hangzhou.aliyuncs.com --docker-username=xxx --docker-password=xxx [--docker-email=xxxx@xxx.com]
```

3、添加密钥到namespace
```
kubectl patch serviceaccount default -p '{"imagePullSecrets": [{"name": "alidockerregistryssecret"}]}'
```

4、修改启动的xxx.yml,在kubectl apply -f xxx.yml
给spec:template:下的容器配置secrets
```
spec:
  serviceAccountName: default
  imagePullSecrets:
    - name: alidockerregistryssecret
  containers:
    - image: registry.cn-hangzhou.aliyuncs.com/qzliao/app:h5-cc-1.0.1
      name: go
      imagePullPolicy: Always
      command: ["./main","-v","v1.0.1"]
      ports:
        - containerPort: 8404
          protocol: TCP

```

# 六、注意事项
## 1、启动出错：/proc/sys/net/bridge/bridge-nf-call- iptables does not exist

1、执行```modprobe br_netfilter```

2、```vim /etc/sysctl.conf``` 添加以下内容后执行 ```sysctl -p```
```
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
```

## 2、启动失败后无法再次启动
1、执行```minikube profile list```查看集群状态

2、使用```minikube delete --purge --all```删除所有

3、进入```root/.minikube/```查看或清理文件

## 3、证书过期导致kubectl命令无法执行
1、检查证书
```
openssl x509 -in /var/lib/minikube/certs/apiserver.crt -noout -dates
```

2、删除集群重启时可重新获取证书
```

# 【注意】如果需要升级，先执行删除再更新替换/usr/local/bin/minikube，否则无法删除成功
minikube delete


# 【注意】最好执行原版kubernetes，不指定时取最新版安装，安装后难以降级,使用 minikube profile list 查看版本
minikube start --force --driver=none --extra-config=apiserver.service-node-port-range=1-65535 --image-mirror-country='cn' --image-repository='registry.cn-hangzhou.aliyuncs.com/google_containers' --kubernetes-version=v1.22.1
```